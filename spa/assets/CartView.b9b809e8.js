import{Q as $,a as u}from"./QTable.e29c380e.js";import{L as Y,r as c,M as I,c as k,aM as x,aH as v,j as V,k as L,l as o,$ as w,d as a,N as r,a1 as _,U as Q,C as i,aN as P,K as A,n as O,Q as j,a0 as z,aO as E,X as F,V as H,aP as K}from"./index.6fdc5749.js";import{Q as C,a as X,C as G}from"./QForm.5493fe23.js";import{Q as J}from"./QTooltip.aea13b7c.js";import{Q as W}from"./QCheckbox.075c3f6f.js";import{Q as Z}from"./use-key-composition.c8fffae3.js";import"./index.cfa86df7.js";import"./QSeparator.484891f0.js";import"./QMenu.6f89aa27.js";import"./position-engine.8f2ed70e.js";import"./use-prevent-scroll.b5993834.js";import"./QChip.10b328f3.js";import"./QItemLabel.1e968400.js";import"./format.2a3572e1.js";const ee={id:"cart"},te={class:"text-center"},le={class:"div q-px-xl row"},ae={class:"col-12"},re=["src"],oe={class:"flex"},se={class:"col-12"},ne={class:"flex column q-pa-md"},ie=o("h6",{class:"q-pa-none q-ma-none"},"\u70BA\u78BA\u8A8D\u60A8\u5DF2\u662F\u6210\u5E74\u4EBA\uFF0C",-1),ue=o("h6",{class:"q-pa-none q-ma-none"},"\u8ACB\u8F38\u5165\u60A8\u771F\u5BE6\u7684\u51FA\u751F\u5E74\u6708\u65E5\u53CA\u59D3\u540D\u3002",-1),de=o("p",{class:"q-mt-md"},"\u8ACB\u8F38\u5165\u59D3\u540D",-1),ce={align:"center"},Ue={__name:"CartView",setup(me){P();const U=A(),T=Y(),{editCart:B,checkout:D,editUser:M}=T,b=c(""),h=c(!1),m=c(!1),p=c(""),f=c(""),s=I([]),d={required(e){return!!e||"\u6B04\u4F4D\u5FC5\u586B"},maxLength(e){return e.length<=20||"\u6700\u591A\u8F38\u516520\u500B\u5B57"},countyYears(e){const l=new Date(e).getTime(),t=new Date().getTime(),n=1e3*60*60*24*365,y=Math.abs(t-l);return Math.trunc(y/n)>=18},requiredCheckbox(e){return e===!0||"\u8ACB\u78BA\u8A8D\u60A8\u5DF2\u662F\u6210\u5E74\u4EBA"}},S=[{name:"name",required:!0,label:"\u5546\u54C1\u540D\u7A31",align:"left",field:e=>e.p_id.name,sortable:!0},{name:"image",required:!0,label:"\u5546\u54C1\u5716\u7247",align:"left",field:e=>e.p_id.image,sortable:!0},{name:"price",required:!0,label:"\u5546\u54C1\u50F9\u683C",align:"left",field:e=>e.p_id.price,sortable:!0},{name:"quantity",required:!0,label:"\u5546\u54C1\u6578\u91CF",align:"left",field:e=>e.quantity,sortable:!0},{name:"value",required:!0,label:"\u5C0F\u8A08",align:"left",field:e=>e,format:e=>e.p_id.price*e.quantity,sortable:!0},{name:"edit",required:!0,label:"\u7DE8\u8F2F",align:"left"}],g=async(e,l,t)=>{const n=s.findIndex(y=>y._id===e);console.log(n),await B({_id:s[n].p_id._id,quantity:l,text:t}),s[n].quantity+=l,s[n].quantity<=0&&s.splice(n,1)},q=async e=>{try{const{data:l}=await x.get("/users/me");if(!l.result.birth||!l.result.username)await M({username:p.value,birth:f.value});else if(f.value!==l.result.birth||p.value!==l.result.username){v.fire({icon:"error",title:"\u5931\u6557",text:"\u8CC7\u6599\u932F\u8AA4"});return}m.value=!1,await D(),console.log("2"),U.push("/Mypage/MypageOrders")}catch(l){console.log(l),v.fire({icon:"error",title:"\u5931\u6557",text:"\u7D50\u5E33\u5931\u6557"})}},N=k(()=>s.reduce((e,l)=>e+l.p_id.price*l.quantity,0)),R=k(()=>s.length>0&&!s.some(e=>!e.p_id.sell));return(async()=>{try{const{data:e}=await x.get("/users/cart");s.push(...e.result),console.log(s)}catch{v.fire({icon:"error",title:"\u5931\u6557",text:"\u53D6\u5F97\u8CFC\u7269\u8ECA\u5931\u6557"})}})(),(e,l)=>(V(),L("div",ee,[o("h3",te,[w("\u8CFC\u7269\u8ECA"),o("div",le,[o("div",ae,[a($,{columns:S,rows:s,"row-key":"p_id",filter:b.value},{"body-cell":r(t=>[a(u,{class:O({"bg-red":!t.row.p_id.sell})},null,8,["class"])]),"top-right":r(()=>[a(C,{borderless:"",dense:"",debounce:"300",modelValue:b.value,"onUpdate:modelValue":l[0]||(l[0]=t=>b.value=t),placeholder:"Search"},{append:r(()=>[a(j,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-name":r(t=>[a(u,null,{default:r(()=>[o("p",null,_(t.row.p_id.name),1)]),_:2},1024)]),"body-cell-image":r(t=>[a(u,null,{default:r(()=>[o("img",{src:t.row.p_id.image,style:{height:"100px"}},null,8,re)]),_:2},1024)]),"body-cell-price":r(t=>[a(u,null,{default:r(()=>[o("p",null,_(t.row.p_id.price),1)]),_:2},1024)]),"body-cell-quantity":r(t=>[a(u,null,{default:r(()=>[o("div",oe,[a(i,{color:"primary",onClick:n=>g(t.row._id,-1,"\u4FEE\u6539\u6210\u529F"),label:"-"},null,8,["onClick"]),o("p",null,"\xA0"+_(t.row.quantity)+"\xA0",1),a(i,{color:"primary",onClick:n=>g(t.row._id,1,"\u4FEE\u6539\u6210\u529F"),label:"+"},null,8,["onClick"])])]),_:2},1024)]),"body-cell-edit":r(t=>[a(u,null,{default:r(()=>[a(i,{round:"",color:"red",onClick:n=>g(t.row._id,t.row.quantity*-1,"\u522A\u9664\u5546\u54C1"),icon:"fa-solid fa-trash-can"},null,8,["onClick"])]),_:2},1024)]),_:1},8,["rows","filter"])]),o("div",se,[o("p",null,"\u7E3D\u91D1\u984D "+_(Q(N)),1),a(i,{color:"green",disabled:!Q(R),onClick:l[1]||(l[1]=t=>m.value=!0),label:"\u7D50\u5E33"},null,8,["disabled"])])]),a(Z,{modelValue:m.value,"onUpdate:modelValue":l[5]||(l[5]=t=>m.value=t),persistent:""},{default:r(()=>[a(z,{class:"bg-accent text-white",style:{width:"500px"}},{default:r(()=>[a(X,{onSubmit:q,onReset:e.onReset},{default:r(()=>[a(E,{align:"right"},{default:r(()=>[F((V(),H(i,{dense:"",flat:"",icon:"close"},{default:r(()=>[a(J,null,{default:r(()=>[w("Close")]),_:1})]),_:1})),[[G]])]),_:1}),a(K,{class:"bg-white text-accent",align:"center"},{default:r(()=>[o("div",ne,[ie,ue,de,a(C,{filled:"",modelValue:p.value,"onUpdate:modelValue":l[2]||(l[2]=t=>p.value=t),label:"\u8ACB\u8F38\u5165\u60A8\u7684\u771F\u5BE6\u59D3\u540D",rules:[d.required,d.maxLength]},null,8,["modelValue","rules"]),a(C,{type:"date",modelValue:f.value,"onUpdate:modelValue":l[3]||(l[3]=t=>f.value=t),label:"\u8ACB\u8F38\u5165\u60A8\u7684\u51FA\u751F\u5E74\u6708\u65E5",rules:[d.required,d.countyYears]},null,8,["modelValue","rules"]),a(W,{class:"checkbox",modelValue:h.value,"onUpdate:modelValue":l[4]||(l[4]=t=>h.value=t),rules:[d.requiredCheckbox]},{default:r(()=>[w("\u6211\u771F\u7684\u662F\u6210\u5E74\u4EBA!!")]),_:1},8,["modelValue","rules"]),o("div",ce,[a(i,{type:"reset",color:"red",flat:"",label:"reset"}),a(i,{flat:"",type:"submit",label:"submit",disabled:!h.value,onClick:q},null,8,["disabled"])])])]),_:1})]),_:1},8,["onReset"])]),_:1})]),_:1},8,["modelValue"])])]))}};export{Ue as default};
